generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Quiz {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        QuizType      @default(NORMAL)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  questions   Question[]
  attempts    QuizAttempt[]

  @@index([type])
  @@index([createdAt])
}

model Question {
  id               String            @id @default(cuid())
  quizId           String?
  text             String
  optionA          String
  optionB          String
  optionC          String
  optionD          String
  correctAnswer    String
  explanation      String?
  order            Int?
  createdAt        DateTime          @default(now())
  difficulty       Difficulty        @default(MEDIUM)
  isActive         Boolean           @default(true)
  number           Int               @default(autoincrement())
  updatedAt        DateTime          @default(now()) @updatedAt
  answers          Answer[]
  quiz             Quiz?             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionAttempts QuestionAttempt[]
  tags             QuestionTag[]

  @@index([quizId])
  @@index([quizId, order])
  @@index([number])
  @@index([difficulty])
  @@index([isActive])
}

model Tag {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  questions   QuestionTag[]

  @@index([name])
}

model QuestionTag {
  id         String   @id @default(cuid())
  questionId String
  tagId      String
  createdAt  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([questionId, tagId])
  @@index([questionId])
  @@index([tagId])
}

model QuestionAttempt {
  id             String        @id @default(cuid())
  questionId     String
  userId         String
  userEmail      String
  selectedAnswer String
  isCorrect      Boolean
  source         AttemptSource @default(INDIVIDUAL)
  answeredAt     DateTime      @default(now())
  question       Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionId])
  @@index([answeredAt])
  @@index([userId, questionId])
  @@index([source])
}

model UserStats {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  userEmail               String
  totalQuestionsAnswered  Int       @default(0)
  totalCorrectAnswers     Int       @default(0)
  easyQuestionsAnswered   Int       @default(0)
  easyCorrectAnswers      Int       @default(0)
  mediumQuestionsAnswered Int       @default(0)
  mediumCorrectAnswers    Int       @default(0)
  hardQuestionsAnswered   Int       @default(0)
  hardCorrectAnswers      Int       @default(0)
  totalQuizzesTaken       Int       @default(0)
  dailyQuizzesTaken       Int       @default(0)
  currentStreak           Int       @default(0)
  longestStreak           Int       @default(0)
  lastAnsweredDate        DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([userId])
  @@index([totalCorrectAnswers])
  @@index([currentStreak])
}

model QuizAttempt {
  id             String   @id @default(cuid())
  quizId         String
  userId         String
  userEmail      String
  score          Int
  totalQuestions Int
  completedAt    DateTime @default(now())
  answers        Answer[]
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([completedAt])
  @@index([userId, quizId, completedAt])
  @@index([score])
}

model Answer {
  id             String      @id @default(cuid())
  attemptId      String
  questionId     String
  selectedAnswer String
  isCorrect      Boolean
  answeredAt     DateTime    @default(now())
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

enum QuizType {
  NORMAL
  DAILY
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum AttemptSource {
  INDIVIDUAL
  DAILY_QUIZ
  NORMAL_QUIZ
}
